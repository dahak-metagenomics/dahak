# Running Workflows

Dahak workflows are run from the command line using Snakemake, a Python package
that provides similar capabilities to GNU make. Each workflow consists of a set
of Snakemake rules.

[Snakemake](https://snakemake.readthedocs.io/) is a Python program that assembles and
runs tasks using a task graph approach. See [Installing](installing.md) for
instructions on how to install it. 

Dahak workflows benefit directly from Snakemake's rich feature set and capabilities.
There is an extensive documentation page on [executing Snakemake](https://snakemake.readthedocs.io/en/stable/executable.html),
and its command line options. There are other projects demonstrating ways of creating 
[snakemake-profiles](https://github.com/snakemake-profiles/doc), or platform-specific
configuration profiles.


## Running Workflows Using Snakemake Targets

Generally, Snakemake is called by passing command line flags and the name of a
target file or rule name:

```
$ snakemake [FLAGS] <target>
```

The target can either be a file that is generated by a rule, or the name of a
rule itself. These rules are defined in a file in the working directory named
`Snakefile`.

**Target Files:** The user can specify the name of a target file for Snakemake
to generate, and it will dynamically build a dependency graph of rules that must
be run to generate a particular output file. If a rule has required input files
that are not present, Snakemake will add the rule that generates those input
files to the dependency graph.

_Example:_ `$ snakemake krona_report_XYZ123.html`

**Build Rules:** A build rule is a rule that does not run any commands but
requires input files that are generated in the last step of a workflow. This
allows a single rule to trigger the entire workflow. (The build rules work by
assembling filenames and passing target filenames to Snakemake.)

_Example:_ `$ snakemake make_krona_reports`


## Running Workflows With Singularity

Singularity is a containerization technology similar to Docker but without the
need for root access. Snakefiles in Dahak contain `singularity:` directives,
which specify a Singularity image to pull and use to run the given commands.
These directives are ignored by default, Snakemake must be run with the
`--use-singularity` flag to run each command through a singularity container:

```
snakemake --use-singularity <target>
```

When Singularity containers are run, a host directory can be bind-mounted
inside the container to provide a shared-access folder on the host filesystem.
To specify a directory for Singularity to bind-mount, use the
`SINGULARITY_BINDPATH` environment variable:

```
$ SINGULARITY_BINDPATH="my_data:/data" snakemake --use-singularity <target>
```

This bind-mounts the directory `my_data/` into the Singularity container at `/data/`.


## Running Workflows with Configuration Files

To use a custom configuration file (JSON or YAML format), use the
`--configfile` flag:

```
$ snakemake --configfile my_workflow_params.json ...
```


## Summary

All together, this will look like:

```
$ SINGULARITY_BINDPATH="data:/data" snakemake \
    --configfile my_workflow_params.json \
    --use-singularity \
    <snakemake-target>
``` 

